// ==UserScript==
// @name         HKU Moodle Tweaks
// @version      1.2.4
// @description  Simple Fix for HKU Moodle
// @author       nohackjustnoobb
// @match        https://moodle.hku.hk/*
// @downloadURL  https://raw.githubusercontent.com/nohackjustnoobb/HKU-Moodle-Tweaks/master/build/HKU%20Moodle%20Tweaks.user.js
// @updateURL    https://raw.githubusercontent.com/nohackjustnoobb/HKU-Moodle-Tweaks/master/build/HKU%20Moodle%20Tweaks.user.js
// @grant        GM.setValue
// @grant        GM.getValue
// ==/UserScript==

const pageRegex={homepage:/^https:\/\/moodle\.hku\.hk\/?#?$/,courseView:/^https:\/\/moodle\.hku\.hk\/course\/view\.php\?id=.*$/};let currPage=null;for(const[e,t]of Object.entries(pageRegex))window.location.href.match(t)&&(currPage=e);function toggleSettings(){const e=document.getElementById("hmt-settings");e&&e.classList.toggle("hmt-hide")}const calendarOnChange=()=>toggleUselessComponents(!1);async function toggleUselessComponents(e=!0){let t="1"===await GM.getValue("hmt-hide-useless-components");e&&(t=!t),await GM.setValue("hmt-hide-useless-components",t?"1":"0"),document.getElementById("hmt-hide-useless-components").checked=t;const s=[],n=document.getElementById("inst1256314");n&&s.push(n);const o=document.getElementsByTagName("footer");o.length&&s.push(o[0]);const i=document.getElementsByClassName("footer");i.length&&s.push(...i);const c=document.getElementById("inst4");if(c){const e=c.getElementsByClassName("navigation_node");e.length&&s.push(e[0]);const t=c.querySelectorAll("div > div > ul > li > ul > li");s.push(...Array(...t).slice(0,-1))}const a=document.getElementById("page-header-nav");a&&s.push(a);const d=document.querySelector("#region-main > div > br");if(d&&s.push(d),currPage&&"homepage"===currPage){c&&s.push(c);const e=document.getElementsByClassName("simplesearchform");e.length>0&&s.push(e[0].parentElement);const t=document.getElementById("inst477633");t&&s.push(t);const n=document.querySelector('[data-action="new-event-button"]');n&&s.push(n);const o=document.querySelectorAll("div > div > a.arrow_link > span.arrow_text");o.length&&s.push(...o);const i=document.getElementById("calendar-course-filter-1");i&&s.push(i.parentElement);const a=document.querySelector("div.paging.paging-morelink");a&&s.push(a)}for(const e of s)t?e.classList.add("hmt-hide"):e.classList.remove("hmt-hide");let l=document.getElementsByClassName("maincalendar");l.length&&(l=l[0].children[0],l.removeEventListener("DOMNodeInserted",calendarOnChange),l.addEventListener("DOMNodeInserted",calendarOnChange))}async function toggleCourseImages(e=!0){let t="1"===await GM.getValue("hmt-hide-course-images");e&&(t=!t),await GM.setValue("hmt-hide-course-images",t?"1":"0"),document.getElementById("hmt-hide-course-images").checked=t;const s=[];if("homepage"===currPage){const e=document.getElementsByClassName("courseimage");e.length&&s.push(...e);let t=document.querySelector("#frontpage-course-list > div");t&&(t=t.getElementsByTagName("img")),t.length&&s.push(...t)}for(const e of s)t?e.classList.add("hmt-hide"):e.classList.remove("hmt-hide")}async function toggleRandomUITweaks(e=!0){let t="1"===await GM.getValue("hmt-random-ui-tweaks");e&&(t=!t),await GM.setValue("hmt-random-ui-tweaks",t?"1":"0"),document.getElementById("hmt-random-ui-tweaks").checked=t,t?document.body.classList.add("hmt-style"):document.body.classList.remove("hmt-style")}async function toggleDarkTheme(e=!0){let t="1"===await GM.getValue("hmt-dark-theme");e&&(t=!t),await GM.setValue("hmt-dark-theme",t?"1":"0"),document.getElementById("hmt-dark-theme").checked=t,t?document.documentElement.classList.add("hmt-style"):document.documentElement.classList.remove("hmt-style")}async function coursesFilterOnchange(e){const t=e?e.value:await GM.getValue("hmt-courses-filter")||"0";await GM.setValue("hmt-courses-filter",t),document.getElementById("hmt-courses-filter").value=t;let s=[],n=-1,o=-1;const i=document.querySelectorAll("#inst476784 > div > div > ul > li > div > a"),c=[];for(const e of i){const t={id:/^https:\/\/moodle\.hku\.hk\/course\/view\.php\?id=(.*)$/.exec(e.getAttribute("href"))[1],title:e.getAttribute("title")},s=/^(.*)_(\w{0,3})_(\d{4})$/.exec(t.title);s&&(t.code=s[1],t.sem=Number(s[2][0]),t.year=Number(s[3]),t.year>=n&&(t.sem>o&&(o=t.sem),n=t.year)),c.push(t)}const a=(await GM.getValue("hmt-filters")||"").split("|"),d=document.getElementById("hmt-courses-list");if(d)if(d.classList.add("hmt-hide"),d.innerHTML)for(const e of d.getElementsByTagName("input"))e.checked=!a.find((t=>t===e.getAttribute("courseId")));else{const e=document.createElement("ul");for(const t of c){const s=document.createElement("div");s.innerText=t.title;const n=document.createElement("input");n.type="checkbox",n.setAttribute("courseId",t.id),n.checked=!a.find((e=>e===t.id)),n.addEventListener("change",(async e=>{const t=e.target.getAttribute("courseId");let s=(await GM.getValue("hmt-filters")||"").split("|");e.target.checked?s=s.filter((e=>e!==t)):s.find((e=>e===t))||s.push(t),await GM.setValue("hmt-filters",s.join("|")),coursesFilterOnchange()}));const o=document.createElement("li");o.appendChild(s),o.appendChild(n),e.appendChild(o)}d.appendChild(e)}switch(t){case"1":for(const e of c)(e.year<n||e.sem<o)&&s.push(e);break;case"2":for(const e of c)(!e.year||!e.sem||e.year<n||e.sem<o)&&s.push(e);break;case"3":d&&d.classList.remove("hmt-hide"),s=c.filter((e=>a.find((t=>t===e.id))))}const l=document.querySelectorAll("#frontpage-course-list > div > div.coursebox");for(const e of l)s.find((t=>t.id===e.getAttribute("data-courseid")))?e.classList.add("hmt-hide"):e.classList.remove("hmt-hide");const m=document.querySelectorAll("#inst476784 > div > div > ul > li");for(const e of m)s.find((t=>t.title===e.children[0].children[0].getAttribute("title")))?e.classList.add("hmt-hide"):e.classList.remove("hmt-hide")}function fromHTML(e){if(!e)return null;const t=document.createElement("template");t.innerHTML=e;const s=t.content.children;return 1===s.length?s[0]:s}const menu=document.getElementById("action-menu-0-menu");if(menu){menu.appendChild(fromHTML("<div class=dropdown-divider role=presentation><span class=filler></span></div>"));const e=fromHTML('<a style=cursor:pointer aria-labelledby=actionmenuaction-1 class="dropdown-item menu-action" data-title=grades,grades role=menuitem tabindex=-1><span class=menu-action-text id=actionmenuaction-1>Tweaks</span></a>');menu.appendChild(e),e.addEventListener("click",toggleSettings)}const settings=fromHTML("<div id=hmt-settings class=hmt-hide><div class=background></div><div class=container><h2>HKU Moodle Tweaks</h2><ul><li><div>Hide useless components:</div><input type=checkbox id=hmt-hide-useless-components><li><div>Hide course images:</div><input type=checkbox id=hmt-hide-course-images><li><div>Random UI tweaks:</div><input type=checkbox id=hmt-random-ui-tweaks><li><div>Dark theme support:</div><input type=checkbox id=hmt-dark-theme><li><div>Courses filter:</div><select id=hmt-courses-filter><option value=0>Disabled<option value=1>Auto Detect<option value=2>Auto Detect (Aggressive)<option value=3>Manual</select><li id=hmt-courses-list class=hmt-hide></ul><button id=hmt-close>Close</button><div id=source>This extension is <a href=https://github.com/nohackjustnoobb/HKU-Moodle-Tweaks target=_blank>open-sourced</a> under the MIT licence.</div></div></div>");document.body.appendChild(settings);const bg=settings.getElementsByClassName("background")[0];bg.addEventListener("click",toggleSettings);const hideUseless=document.getElementById("hmt-hide-useless-components");hideUseless.addEventListener("click",toggleUselessComponents);const hideImg=document.getElementById("hmt-hide-course-images");hideImg.addEventListener("click",toggleCourseImages);const randomUITweaks=document.getElementById("hmt-random-ui-tweaks");randomUITweaks.addEventListener("click",toggleRandomUITweaks);const coursesFilter=document.getElementById("hmt-courses-filter");coursesFilter.addEventListener("change",(e=>coursesFilterOnchange(e.target)));const darkTheme=document.getElementById("hmt-dark-theme");darkTheme.addEventListener("click",toggleDarkTheme);const close=document.getElementById("hmt-close");close.addEventListener("click",toggleSettings),coursesFilterOnchange(),toggleUselessComponents(!1),toggleCourseImages(!1),toggleRandomUITweaks(!1),toggleDarkTheme(!1);

const s = document.createElement("style");
s.innerText = ".hmt-hide{display:none!important}body.hmt-style #frontpage-course-list{padding:0}body.hmt-style #frontpage-course-list h2{margin:0}body.hmt-style #block-region-side-post .block{border-radius:1rem;background-color:#e6f5f2}body.hmt-style #inst3>div>#instance-3-header{text-align:center}body.hmt-style #inst3>div>#instance-3-header::before{display:none}body.hmt-style #inst3>div>div{padding-top:0}body.hmt-style #inst3 div[data-region=day-content] ul{display:flex;justify-content:center;gap:.25rem}body.hmt-style #inst3 div[data-region=day-content] li{background-color:#00b48d;height:.5rem;width:.5rem;border-radius:50%;overflow:hidden;line-height:0}body.hmt-style #inst3 .calendar_event_course{background-color:transparent}body.hmt-style #inst3 thead{background-color:#bae8df}body.hmt-style .coursebox{padding:1rem;padding-left:0;padding-right:0;margin:0}body.hmt-style .coursebox .content{display:flex;align-items:center}@media screen and (max-width:767px){.hmt-style .coursebox .content{justify-content:center;flex-direction:column;align-items:start}}.hmt-style .coursebox .content .courseimage{flex-shrink:0}.hmt-style .coursebox .content .teachers{display:none}.hmt-style .course-btn{flex-shrink:0}.hmt-style .course-btn .btn{border-radius:.5rem}.hmt-style #sidebar img.icon{display:none}.hmt-style #sidebar .unlist{display:flex;flex-direction:column;gap:.5rem}.hmt-style #sidebar #instance-476784-header{text-align:center}.hmt-style #sidebar #instance-476784-header::before{display:none}.hmt-style .btn.icons-collapse-expand.stretched-link{background-color:transparent!important}.hmt-style .btn.icons-collapse-expand.stretched-link:hover{background-color:transparent!important}.hmt-style .btn.icons-collapse-expand.stretched-link:focus{outline:0}@media (prefers-color-scheme:dark){html.hmt-style,html.hmt-style iframe,html.hmt-style img.nofilter,html.hmt-style img:not(.activityicon),html.hmt-style video{filter:invert(100%) hue-rotate(180deg)}}#hmt-settings{display:flex;justify-content:center;align-items:center;position:fixed;top:0;left:0;width:100vw;height:100vh}#hmt-settings .background{width:100%;height:100%;position:absolute;left:0;right:0;z-index:-1;background-color:#000;opacity:.25}#hmt-settings .container{display:flex;flex-direction:column;background-color:#fff;max-width:500px;max-height:400px;margin:1rem;border-radius:1rem;padding-top:2rem;padding-left:3rem;padding-right:3rem;padding-bottom:1rem}#hmt-settings .container h2{text-align:center;margin:0}#hmt-settings .container ul{list-style-type:none;display:flex;flex-direction:column;margin:0;margin-top:1rem;margin-bottom:1rem;padding:0;gap:.5rem}#hmt-settings .container ul li{display:flex;align-items:center;gap:1rem}#hmt-settings .container button,#hmt-settings .container select{margin:0}#hmt-settings .container button{border-radius:.5rem}#hmt-settings #source{text-align:center}#hmt-settings #hmt-courses-list{overflow-y:scroll;height:8rem;align-items:start!important}#hmt-settings #hmt-courses-list ul{width:100%}#hmt-settings #hmt-courses-list ul li{display:flex;justify-content:space-between}";
document.body.appendChild(s)
