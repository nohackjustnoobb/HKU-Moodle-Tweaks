// ==UserScript==
// @name         HKU Moodle Tweaks
// @version      1.1.0
// @description  Simple Fix for HKU Moodle
// @author       nohackjustnoobb
// @match        https://moodle.hku.hk/*
// @downloadURL  https://raw.githubusercontent.com/nohackjustnoobb/HKU-Moodle-Tweaks/master/build/HKU%20Moodle%20Tweaks.user.js
// @updateURL    https://raw.githubusercontent.com/nohackjustnoobb/HKU-Moodle-Tweaks/master/build/HKU%20Moodle%20Tweaks.user.js
// ==/UserScript==

const script = document.createElement("script");
script.innerText = "const pageRegex={homepage:/^https:\\/\\/moodle\\.hku\\.hk\\/?#?$/,courseView:/^https:\\/\\/moodle\\.hku\\.hk\\/course\\/view\\.php\\?id=.*$/};let currPage=null;for(const[e,t]of Object.entries(pageRegex))window.location.href.match(t)&&(currPage=e);function toggleSettings(){const e=document.getElementById(\"hmt-settings\");e&&e.classList.toggle(\"hmt-hide\")}const calendarOnChange=()=>toggleUselessComponents(!1);function toggleUselessComponents(e=!0){let t=\"1\"===localStorage.getItem(\"hmt-hide-useless-components\");e&&(t=!t),localStorage.setItem(\"hmt-hide-useless-components\",t?\"1\":\"0\"),document.getElementById(\"hmt-hide-useless-components\").checked=t;const s=[],o=document.getElementById(\"inst1256314\");o&&s.push(o);const n=document.getElementsByTagName(\"footer\");n.length&&s.push(n[0]);const c=document.getElementsByClassName(\"footer\");c.length&&s.push(...c);const l=document.getElementById(\"inst4\");if(l){const e=l.getElementsByClassName(\"navigation_node\");e.length&&s.push(e[0]);const t=l.querySelectorAll(\"div > div > ul > li > ul > li\");s.push(...Array(...t).slice(0,-1))}const i=document.getElementById(\"page-header-nav\");i&&s.push(i);const r=document.querySelector(\"#region-main > div > br\");if(r&&s.push(r),currPage&&\"homepage\"===currPage){l&&s.push(l);const e=document.getElementsByClassName(\"simplesearchform\");e.length>0&&s.push(e[0].parentElement);const t=document.getElementById(\"inst477633\");t&&s.push(t);const o=document.querySelector(\'[data-action=\"new-event-button\"]\');o&&s.push(o);const n=document.querySelectorAll(\"div > div > a.arrow_link > span.arrow_text\");n.length&&s.push(...n);const c=document.getElementById(\"calendar-course-filter-1\");c&&s.push(c.parentElement);const i=document.querySelector(\"div.paging.paging-morelink\");i&&s.push(i)}for(const e of s)t?e.classList.add(\"hmt-hide\"):e.classList.remove(\"hmt-hide\");let d=document.getElementsByClassName(\"maincalendar\");d.length&&(d=d[0].children[0],d.removeEventListener(\"DOMNodeInserted\",calendarOnChange),d.addEventListener(\"DOMNodeInserted\",calendarOnChange))}function toggleCourseImages(e=!0){let t=\"1\"===localStorage.getItem(\"hmt-hide-course-images\");e&&(t=!t),localStorage.setItem(\"hmt-hide-course-images\",t?\"1\":\"0\"),document.getElementById(\"hmt-hide-course-images\").checked=t;const s=[];\"homepage\"===currPage&&s.push(...document.getElementsByClassName(\"courseimage\"),...document.querySelector(\"#frontpage-course-list > div\").getElementsByTagName(\"img\"));for(const e of s)t?e.classList.add(\"hmt-hide\"):e.classList.remove(\"hmt-hide\")}function toggleRandomUITweaks(e=!0){let t=\"1\"===localStorage.getItem(\"hmt-random-ui-tweaks\");e&&(t=!t),localStorage.setItem(\"hmt-random-ui-tweaks\",t?\"1\":\"0\"),document.getElementById(\"hmt-random-ui-tweaks\").checked=t,t?document.body.classList.add(\"hmt-style\"):document.body.classList.remove(\"hmt-style\")}function coursesFilterOnchange(e){const t=e?e.value:localStorage.getItem(\"hmt-courses-filter\")||\"0\";localStorage.setItem(\"hmt-courses-filter\",t),document.getElementById(\"hmt-courses-filter\").value=t;let s=[],o=-1,n=-1;const c=document.querySelectorAll(\"#inst476784 > div > div > ul > li > div > a\"),l=[];for(const e of c){const t={id:/^https:\\/\\/moodle\\.hku\\.hk\\/course\\/view\\.php\\?id=(.*)$/.exec(e.getAttribute(\"href\"))[1],title:e.getAttribute(\"title\")},s=/^(.*)_(\\w{0,3})_(\\d{4})$/.exec(t.title);s&&(t.code=s[1],t.sem=Number(s[2][0]),t.year=Number(s[3]),t.year>=o&&(t.sem>n&&(n=t.sem),o=t.year)),l.push(t)}const i=(localStorage.getItem(\"hmt-filters\")||\"\").split(\"|\"),r=document.getElementById(\"hmt-courses-list\");if(r)if(r.classList.add(\"hmt-hide\"),r.innerHTML)for(const e of document.getElementsByTagName(\"input\"))e.checked=!i.find((t=>t===e.getAttribute(\"courseId\")));else{const e=document.createElement(\"ul\");for(const t of l){const s=document.createElement(\"div\");s.innerText=t.title;const o=document.createElement(\"input\");o.type=\"checkbox\",o.setAttribute(\"courseId\",t.id),o.checked=!i.find((e=>e===t.id)),o.addEventListener(\"change\",(e=>{const t=e.target.getAttribute(\"courseId\");let s=(localStorage.getItem(\"hmt-filters\")||\"\").split(\"|\");e.target.checked?s=s.filter((e=>e!==t)):s.find((e=>e===t))||s.push(t),localStorage.setItem(\"hmt-filters\",s.join(\"|\")),coursesFilterOnchange()}));const n=document.createElement(\"li\");n.appendChild(s),n.appendChild(o),e.appendChild(n)}r.appendChild(e)}switch(t){case\"1\":for(const e of l)(e.year<o||e.sem<n)&&s.push(e);break;case\"2\":for(const e of l)(!e.year||!e.sem||e.year<o||e.sem<n)&&s.push(e);break;case\"3\":r&&r.classList.remove(\"hmt-hide\"),s=l.filter((e=>i.find((t=>t===e.id))))}const d=document.querySelectorAll(\"#frontpage-course-list > div > div.coursebox\");for(const e of d)s.find((t=>t.id===e.getAttribute(\"data-courseid\")))?e.classList.add(\"hmt-hide\"):e.classList.remove(\"hmt-hide\");const a=document.querySelectorAll(\"#inst476784 > div > div > ul > li\");for(const e of a)s.find((t=>t.title===e.children[0].children[0].getAttribute(\"title\")))?e.classList.add(\"hmt-hide\"):e.classList.remove(\"hmt-hide\")}function a(A){if(!A)return null;var _=document.createElement(\'template\'),c=_.content.children;_.innerHTML=A;if(c.length==1)return c[0];return c}var b=document.getElementById(\'action-menu-0-menu\');b&&(b.appendChild(a(\'<div class=dropdown-divider role=presentation><span class=filler></span></div>\')),b.appendChild(a(\'<a onclick=toggleSettings() style=cursor:pointer aria-labelledby=actionmenuaction-1 class=\\\"dropdown-item menu-action\\\" data-title=grades,grades role=menuitem tabindex=-1><span class=menu-action-text id=actionmenuaction-1>Tweaks</span></a>\')));document.body.appendChild(a(\'<div id=hmt-settings class=hmt-hide><div class=background onclick=toggleSettings()></div><div class=container><h2>HKU Moodle Tweaks</h2><ul><li><div>Hide useless components:</div><input type=checkbox id=hmt-hide-useless-components onclick=toggleUselessComponents()><li><div>Hide course images:</div><input type=checkbox id=hmt-hide-course-images onclick=toggleCourseImages()><li><div>Random UI tweaks:</div><input type=checkbox id=hmt-random-ui-tweaks onclick=toggleRandomUITweaks()><li><div>Courses filter:</div><select id=hmt-courses-filter onchange=coursesFilterOnchange(this)><option value=0>Disabled<option value=1>Auto Detect<option value=2>Auto Detect (Aggressive)<option value=3>Manual</select><li id=hmt-courses-list class=hmt-hide></ul><button onclick=toggleSettings()>Close</button></div></div>\'));coursesFilterOnchange();toggleUselessComponents(!1);toggleCourseImages(!1);toggleRandomUITweaks(!1);";
document.body.appendChild(script)

const style = document.createElement("style");
style.innerText = "#hmt-settings{display:flex;justify-content:center;align-items:center;position:fixed;top:0;left:0;width:100vw;height:100vh}.hmt-hide{display:none!important}#hmt-settings .background{width:100%;height:100%;position:absolute;left:0;right:0;z-index:-1;background-color:#000;opacity:.25}#hmt-settings .container{display:flex;flex-direction:column;background-color:#fff;max-width:500px;max-height:400px;border-radius:1rem;padding:2rem;padding-left:3rem;padding-right:3rem}#hmt-settings .container h2{text-align:center;margin:0}#hmt-settings .container ul{list-style-type:none;display:flex;flex-direction:column;margin:0;margin-top:1rem;margin-bottom:1rem;padding:0;gap:.5rem}#hmt-settings .container ul li{display:flex;align-items:center;gap:1rem}#hmt-settings .container button,#hmt-settings .container select{margin:0}#hmt-settings .container button{border-radius:.5rem}#hmt-courses-list{overflow-y:scroll;height:8rem;align-items:start!important}#hmt-courses-list ul{width:100%}#hmt-courses-list ul li{display:flex;justify-content:space-between}.hmt-style #frontpage-course-list{padding:0}.hmt-style #frontpage-course-list h2{margin:0}.hmt-style #block-region-side-post .block{border-radius:1rem;background-color:#e6f5f2}.hmt-style #inst3>div>#instance-3-header{text-align:center}.hmt-style #inst3>div>#instance-3-header::before{display:none}.hmt-style #inst3>div>div{padding-top:0}.hmt-style #inst3 div[data-region=day-content] ul{display:flex;justify-content:center;gap:.25rem}.hmt-style #inst3 div[data-region=day-content] li{background-color:#00b48d;height:.5rem;width:.5rem;border-radius:50%;overflow:hidden;line-height:0}.hmt-style #inst3 .calendar_event_course{background-color:transparent}.hmt-style #inst3 thead{background-color:#bae8df}.hmt-style .coursebox{padding:1rem;padding-left:0;padding-right:0;margin:0}.hmt-style .coursebox .content{display:flex;align-items:center}@media screen and (max-width:767px){.hmt-style .coursebox .content{justify-content:center;flex-direction:column;align-items:start}}.hmt-style .coursebox .content .courseimage{flex-shrink:0}.hmt-style .coursebox .content .teachers{display:none}.hmt-style .course-btn{flex-shrink:0}.hmt-style .course-btn .btn{border-radius:.5rem}.hmt-style #sidebar img.icon{display:none}.hmt-style #sidebar .unlist{display:flex;flex-direction:column;gap:.5rem}.hmt-style #sidebar #instance-476784-header{text-align:center}.hmt-style #sidebar #instance-476784-header::before{display:none}.hmt-style .btn.icons-collapse-expand.stretched-link{background-color:transparent!important}.hmt-style .btn.icons-collapse-expand.stretched-link:hover{background-color:transparent!important}.hmt-style .btn.icons-collapse-expand.stretched-link:focus{outline:0}";
document.body.appendChild(style)
